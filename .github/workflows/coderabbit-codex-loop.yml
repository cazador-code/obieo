name: CodeRabbit -> Codex Fix Loop

on:
  pull_request_review:
    types: [submitted]
  workflow_dispatch:
    inputs:
      pr_number:
        description: Pull request number to process
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: coderabbit-codex-loop-${{ github.event.pull_request.number || github.event.inputs.pr_number || github.run_id }}
  cancel-in-progress: true

jobs:
  codex-fix:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_review' &&
       (github.event.review.user.login == 'coderabbitai[bot]' || github.event.review.user.login == 'coderabbitai'))
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Resolve PR context
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const eventName = context.eventName;
            const rawInputPr = context.payload?.inputs?.pr_number;
            const prNumber = eventName === 'workflow_dispatch'
              ? Number(rawInputPr)
              : Number(context.payload?.pull_request?.number);

            if (!Number.isFinite(prNumber) || prNumber <= 0) {
              core.setFailed(`Invalid PR number: ${rawInputPr ?? 'none'}`);
              return;
            }

            const { owner, repo } = context.repo;
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });

            core.info(`PR #${prNumber} -> ${pr.head.ref}`);
            core.setOutput('number', String(prNumber));
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('base_ref', pr.base.ref);

      - name: Gather CodeRabbit findings
        id: findings
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const { owner, repo } = context.repo;
            const prNumber = Number(process.env.PR_NUMBER || '0');
            const botLogins = new Set(['coderabbitai[bot]', 'coderabbitai']);

            const [reviewComments, issueComments] = await Promise.all([
              github.paginate(github.rest.pulls.listReviewComments, {
                owner,
                repo,
                pull_number: prNumber,
                per_page: 100,
              }),
              github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number: prNumber,
                per_page: 100,
              }),
            ]);

            const normalize = (body) => (typeof body === 'string' ? body : '').trim();
            const isActionable = (body) => {
              const text = normalize(body).toLowerCase();
              return text.includes('potential issue') || text.includes('prompt for ai agents');
            };

            const all = [];

            for (const c of reviewComments) {
              if (!botLogins.has(c.user?.login || '')) continue;
              if (!isActionable(c.body)) continue;
              all.push({
                kind: 'review_comment',
                id: c.id,
                path: c.path || '',
                line: c.line || c.original_line || null,
                url: c.html_url || '',
                body: normalize(c.body),
              });
            }

            for (const c of issueComments) {
              if (!botLogins.has(c.user?.login || '')) continue;
              if (!isActionable(c.body)) continue;
              all.push({
                kind: 'issue_comment',
                id: c.id,
                path: '',
                line: null,
                url: c.html_url || '',
                body: normalize(c.body),
              });
            }

            const dedupe = new Map();
            for (const item of all) {
              const key = `${item.kind}:${item.path}:${item.line ?? ''}:${item.body.slice(0, 220)}`;
              if (!dedupe.has(key)) dedupe.set(key, item);
            }

            const findings = Array.from(dedupe.values()).sort((a, b) => Number(a.id) - Number(b.id));

            const outDir = path.join(process.env.RUNNER_TEMP || '/tmp', 'codex-coderabbit');
            fs.mkdirSync(outDir, { recursive: true });
            const findingsPath = path.join(outDir, 'findings.md');
            const promptPath = path.join(outDir, 'prompt.md');

            let findingsMd = `# CodeRabbit findings for PR #${prNumber}\n\n`;
            findingsMd += `Total actionable findings: ${findings.length}\n\n`;

            findings.forEach((f, idx) => {
              findingsMd += `## Finding ${idx + 1}\n`;
              findingsMd += `- Kind: ${f.kind}\n`;
              findingsMd += `- File: ${f.path || 'N/A'}\n`;
              findingsMd += `- Line: ${f.line ?? 'N/A'}\n`;
              findingsMd += `- URL: ${f.url || 'N/A'}\n\n`;
              findingsMd += `${f.body}\n\n---\n\n`;
            });

            fs.writeFileSync(findingsPath, findingsMd, 'utf8');

            const prompt = [
              `You are fixing CodeRabbit findings on PR #${prNumber}.`,
              '',
              'Repository rules:',
              '- Fix only actionable, valid findings from the findings document.',
              '- Prefer minimal, root-cause fixes; avoid unrelated refactors.',
              '- If a finding is incorrect, leave code unchanged and document why in your final message.',
              '- Run appropriate local validation commands for touched code.',
              '- Do NOT run git commit or git push; workflow handles that after your edits.',
              '',
              `Read this file first: ${findingsPath}`,
              '',
              'Expected output:',
              '- Apply required code changes in the working tree.',
              '- Provide a concise final message summarizing what was fixed and what was intentionally not changed.',
            ].join('\n');

            fs.writeFileSync(promptPath, prompt, 'utf8');

            core.setOutput('count', String(findings.length));
            core.setOutput('has_findings', findings.length > 0 ? 'true' : 'false');
            core.setOutput('findings_file', findingsPath);
            core.setOutput('prompt_file', promptPath);
            core.info(`Actionable findings: ${findings.length}`);
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}

      - name: Stop when no actionable findings
        if: steps.findings.outputs.has_findings != 'true'
        run: echo "No actionable CodeRabbit findings. Exiting."

      - name: Skip forked PR branches
        if: steps.findings.outputs.has_findings == 'true' && steps.pr.outputs.head_repo != github.repository
        run: |
          echo "PR head repo is a fork (${{ steps.pr.outputs.head_repo }}); skipping auto-push workflow."
          exit 0

      - name: Check out PR head branch
        if: steps.findings.outputs.has_findings == 'true' && steps.pr.outputs.head_repo == github.repository
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0

      - name: Validate OpenAI key is configured
        if: steps.findings.outputs.has_findings == 'true' && steps.pr.outputs.head_repo == github.repository
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "::error::Missing GitHub secret OPENAI_API_KEY. Add it in repo/org secrets first."
            exit 1
          fi

      - name: Configure git author
        if: steps.findings.outputs.has_findings == 'true' && steps.pr.outputs.head_repo == github.repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Run Codex on CodeRabbit findings
        if: steps.findings.outputs.has_findings == 'true' && steps.pr.outputs.head_repo == github.repository
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: ${{ steps.findings.outputs.prompt_file }}
          output-file: ${{ runner.temp }}/codex-coderabbit/final-message.md
          safety-strategy: drop-sudo
          sandbox: workspace-write
          codex-args: --full-auto
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Commit and push Codex fixes
        if: steps.findings.outputs.has_findings == 'true' && steps.pr.outputs.head_repo == github.repository
        id: push
        run: |
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes produced by Codex."
            exit 0
          fi

          git add -A
          git commit -m "Address CodeRabbit review findings"
          git push origin "HEAD:${{ steps.pr.outputs.head_ref }}"

          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Post automation summary
        if: always() && steps.pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const prNumber = Number(`${{ steps.pr.outputs.number }}`);
            const findingsCount = `${{ steps.findings.outputs.count || '0' }}`;
            const hasFindings = `${{ steps.findings.outputs.has_findings || 'false' }}` === 'true';
            const changed = `${{ steps.push.outputs.changed || 'false' }}` === 'true';
            const sha = `${{ steps.push.outputs.commit_sha || '' }}`;
            const status = `${{ job.status }}`;

            let body = `CodeRabbit -> Codex automation run complete.\\n\\n`;
            body += `- Job status: ${status}\\n`;
            body += `- Actionable CodeRabbit findings considered: ${findingsCount}\\n`;

            if (!hasFindings) {
              body += `- Result: No actionable findings detected.\\n`;
            } else if (changed) {
              body += `- Result: Applied fixes and pushed commit ${sha}.\\n`;
            } else {
              body += `- Result: No file changes were produced.\\n`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
